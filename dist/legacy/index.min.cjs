var j=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var ne=Object.prototype.hasOwnProperty;var te=(e,r)=>{for(var n in r)j(e,n,{get:r[n],enumerable:!0})},oe=(e,r,n,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of re(r))!ne.call(e,i)&&i!==n&&j(e,i,{get:()=>r[i],enumerable:!(o=ee(r,i))||o.enumerable});return e};var ie=e=>oe(j({},"__esModule",{value:!0}),e);var Ee={};te(Ee,{$modifier:()=>Z,Changed:()=>De,DESERIALIZE_MODE:()=>X,Not:()=>Re,Or:()=>ve,Types:()=>Ve,addComponent:()=>ke,defineComponent:()=>Pe,defineDeserializer:()=>We,defineQuery:()=>$e,defineSerializer:()=>Ue,enterQuery:()=>Oe,exitQuery:()=>Fe,hasComponent:()=>we,removeComponent:()=>Be});module.exports=ie(Ee);var z=require("bitecs");var f=require("bitecs");var x=Symbol.for("bitecs-u8"),W=Symbol.for("bitecs-i8"),h=Symbol.for("bitecs-u16"),R=Symbol.for("bitecs-i16"),d=Symbol.for("bitecs-u32"),v=Symbol.for("bitecs-i32"),C=Symbol.for("bitecs-f32"),O=Symbol.for("bitecs-f64"),I=Symbol.for("bitecs-ref"),B=Symbol.for("bitecs-str"),P=Symbol.for("bitecs-arr"),U=e=>(r=[])=>Object.defineProperty(r,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ae=(e=[])=>U(x)(e),ye=(e=[])=>U(W)(e),se=(e=[])=>U(h)(e),ue=(e=[])=>U(R)(e),pe=(e=[])=>U(d)(e),le=(e=[])=>U(v)(e),me=(e=[])=>U(C)(e),ce=(e=[])=>U(O)(e),be=(e=[])=>U(I)(e),fe=(e=[])=>U(B)(e),Ae=new Map([[ae,x],[ye,W],[se,h],[ue,R],[pe,d],[le,v],[me,C],[ce,O],[be,I],[fe,B]]),g={[x]:(e,r,n)=>(e.setUint8(r,n),1),[W]:(e,r,n)=>(e.setInt8(r,n),1),[h]:(e,r,n)=>(e.setUint16(r,n),2),[R]:(e,r,n)=>(e.setInt16(r,n),2),[d]:(e,r,n)=>(e.setUint32(r,n),4),[v]:(e,r,n)=>(e.setInt32(r,n),4),[C]:(e,r,n)=>(e.setFloat32(r,n),4),[O]:(e,r,n)=>(e.setFloat64(r,n),8),[I]:(e,r,n)=>(e.setUint32(r,n),4),[B]:(e,r,n)=>{let i=de.encode(n),s=0;return s+=g[d](e,r+s,i.length),new Uint8Array(e.buffer,e.byteOffset+r+s,i.length).set(i),s+=i.length,s}},S={[x]:(e,r)=>({value:e.getUint8(r),size:1}),[W]:(e,r)=>({value:e.getInt8(r),size:1}),[h]:(e,r)=>({value:e.getUint16(r),size:2}),[R]:(e,r)=>({value:e.getInt16(r),size:2}),[d]:(e,r)=>({value:e.getUint32(r),size:4}),[v]:(e,r)=>({value:e.getInt32(r),size:4}),[C]:(e,r)=>({value:e.getFloat32(r),size:4}),[O]:(e,r)=>({value:e.getFloat64(r),size:8}),[I]:(e,r)=>({value:e.getUint32(r),size:4}),[B]:(e,r)=>{let{value:n,size:o}=S[d](e,r),i=new Uint8Array(e.buffer,e.byteOffset+r+o,n);return{value:Te.decode(i),size:o+n}}};function E(e){if(typeof e=="symbol")return e;if(typeof e=="function"){let r=Ae.get(e);if(r)return r;throw new Error(`Unknown type function: ${e}`)}return D(e)?E(e[P]):C}var de=new TextEncoder,Te=new TextDecoder;function V(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function w(e){if(D(e))return E(e[P]);for(let r of[x,W,h,R,d,v,C,O,B,I])if(r in e)return r;return e instanceof Int8Array?W:e instanceof Uint8Array?x:e instanceof Int16Array?R:e instanceof Uint16Array?h:e instanceof Int32Array?v:e instanceof Uint32Array?d:e instanceof Float32Array?C:O}function D(e){return Array.isArray(e)&&P in e}function k(e){return e[P]}function M(e,r,n,o){let i=0,s=Array.isArray(r)?1:0;if(i+=g[x](n,o,s),!s)return i;i+=g[d](n,o+i,r.length);for(let a=0;a<r.length;a++){let t=r[a];if(D(e))i+=M(k(e),t,n,o+i);else{let y=E(e);i+=g[y](n,o+i,t)}}return i}function q(e,r,n,o){let i=0,s=S[x](r,n+i);if(i+=s.size,!s.value)return{size:i};let a=S[d](r,n+i);i+=a.size;let t=new Array(a.value);for(let y=0;y<t.length;y++)if(D(e)){let{value:p,size:m}=q(k(e),r,n+i,o);i+=m,Array.isArray(p)&&(t[y]=p)}else{let p=E(e),{value:m,size:u}=S[p](r,n+i);if(i+=u,p===I){let l=o?o.get(m)??m:m;t[y]=l}else t[y]=m}return{value:t,size:i}}var ge=e=>{let r=w(e);return r===C||r===O},Se=(e,r)=>ge(e)?r:0,Ie=(e,r)=>{let n=e.get(r);return n||(ArrayBuffer.isView(r)?n=new r.constructor(r.length):n=new Array(r.length).fill(0),e.set(r,n)),n},G=(e,r,n,o=1e-4)=>{let i=Ie(e,r),s=r[n],a=Se(r,o),t=a>0?Math.abs(i[n]-s)>a:i[n]!==s;return i[n]=s,t},ze=(e,r=!1,n,o=1e-4)=>{if(V(e)){let t=w(e),y=g[t];return(p,m,u,l)=>{if(r&&n){if(!G(n,e,u,o))return 0;let c=0;return c+=g[d](p,m+c,u),c+=g[d](p,m+c,l),c+=y(p,m+c,e[u]),c}else{let c=0;return c+=g[d](p,m+c,u),c+=y(p,m+c,e[u]),c}}}let i=Object.keys(e),a=i.map(t=>{let y=e[t];if(!V(y))throw new Error(`Invalid array type for property ${t}`);return w(y)}).map(t=>g[t]||(()=>{throw new Error("Unsupported or unannotated type")}));return(t,y,p,m)=>{if(r&&n){let u=0;for(let b=0;b<i.length;b++){let A=e[i[b]];G(n,A,p,o)&&(u|=1<<b)}if(u===0)return 0;let l=0;l+=g[d](t,y+l,p),l+=g[d](t,y+l,m);let c=i.length<=8?g[x]:i.length<=16?g[h]:g[d];l+=c(t,y+l,u);for(let b=0;b<i.length;b++)if(u&1<<b){let A=e[i[b]];D(A)?l+=M(k(A),A[p],t,y+l):l+=a[b](t,y+l,A[p])}return l}else{let u=0;u+=g[d](t,y+u,p);for(let l=0;l<i.length;l++){let c=e[i[l]];D(c)?u+=M(k(c),c[p],t,y+u):u+=a[l](t,y+u,c[p])}return u}}},xe=(e,r=!1)=>{if(V(e)){let s=w(e),a=S[s];return(t,y,p)=>{let m=0,{value:u,size:l}=S[d](t,y);m+=l;let c=p?p.get(u)??u:u;if(r){let{size:T}=S[d](t,y+m);m+=T}let{value:b,size:A}=a(t,y+m);if(s===I){let T=p?p.get(b)??b:b;e[c]=T}else e[c]=b;return m+A}}let n=Object.keys(e),o=n.map(s=>{let a=e[s];if(!V(a))throw new Error(`Invalid array type for property ${s}`);return w(a)}),i=o.map(s=>S[s]||(()=>{throw new Error("Unsupported or unannotated type")}));return(s,a,t)=>{let y=0,{value:p,size:m}=S[d](s,a+y);y+=m;let u=t?t.get(p)??p:p;if(r){let{size:l}=S[d](s,a+y);y+=l;let c=n.length<=8?S[x]:n.length<=16?S[h]:S[d],{value:b,size:A}=c(s,a+y);y+=A;for(let T=0;T<n.length;T++)if(b&1<<T){let F=e[n[T]];if(D(F)){let{value:$,size:Q}=q(k(F),s,a+y,t);Array.isArray($)&&(F[u]=$),y+=Q}else{let{value:$,size:Q}=i[T](s,a+y);if(o[T]===I){let _=t?t.get($)??$:$;e[n[T]][u]=_}else e[n[T]][u]=$;y+=Q}}}else for(let l=0;l<n.length;l++){let c=e[n[l]];if(D(c)){let{value:b,size:A}=q(k(c),s,a+y,t);Array.isArray(b)&&(c[u]=b),y+=A}else{let{value:b,size:A}=i[l](s,a+y);if(o[l]===I){let T=t?t.get(b)??b:b;e[n[l]][u]=T}else e[n[l]][u]=b;y+=A}}return y}},N=(e,r={})=>{let{diff:n=!1,buffer:o=new ArrayBuffer(1024*1024*100),epsilon:i=1e-4}=r,s=new DataView(o),a=n?new Map:void 0,t=e.map(y=>ze(y,n,a,i));return y=>{let p=0;for(let m=0;m<y.length;m++){let u=y[m];for(let l=0;l<t.length;l++)p+=t[l](s,p,u,l)}return o.slice(0,p)}},H=(e,r={})=>{let{diff:n=!1}=r,o=e.map(i=>xe(i,n));return(i,s)=>{let a=new DataView(i),t=0;for(;t<i.byteLength;)if(n){let{value:y,size:p}=S[d](a,t),{value:m,size:u}=S[d](a,t+p);t+=o[m](a,t,s)}else for(let y=0;y<o.length;y++)t+=o[y](a,t,s)}};function he(e,r,n,o){if(!e)return o;if(Array.isArray(e)){let i=e[r];return i!==void 0?I in e?(n.setUint32(o,i),o+4):(n.setFloat64(o,i),o+8):o}if(typeof e=="object"){let i=Object.keys(e).sort();for(let s of i){let a=e[s],t=a[r];t!==void 0&&(a instanceof Int8Array||W in a?(n.setInt8(o,t),o+=1):a instanceof Uint8Array||x in a?(n.setUint8(o,t),o+=1):a instanceof Int16Array||R in a?(n.setInt16(o,t),o+=2):a instanceof Uint16Array||h in a?(n.setUint16(o,t),o+=2):a instanceof Int32Array||v in a?(n.setInt32(o,t),o+=4):a instanceof Uint32Array||d in a||I in a?(n.setUint32(o,t),o+=4):a instanceof Float32Array||C in a?(n.setFloat32(o,t),o+=4):(n.setFloat64(o,t),o+=8))}}return o}function Ce(e,r,n,o,i){if(!e)return o;if(Array.isArray(e)){if(I in e){let s=n.getUint32(o),a=i?i.get(s)??s:s;return e[r]=a,o+4}return e[r]=n.getFloat64(o),o+8}if(typeof e=="object"){let s=Object.keys(e).sort();for(let a of s){let t=e[a];if(t instanceof Int8Array||W in t)t[r]=n.getInt8(o),o+=1;else if(t instanceof Uint8Array||x in t)t[r]=n.getUint8(o),o+=1;else if(t instanceof Int16Array||R in t)t[r]=n.getInt16(o),o+=2;else if(t instanceof Uint16Array||h in t)t[r]=n.getUint16(o),o+=2;else if(t instanceof Int32Array||v in t)t[r]=n.getInt32(o),o+=4;else if(t instanceof Uint32Array||d in t||I in t){let y=n.getUint32(o);if(I in t){let p=i?i.get(y)??y:y;t[r]=p}else t[r]=y;o+=4}else t instanceof Float32Array||C in t?(t[r]=n.getFloat32(o),o+=4):(t[r]=n.getFloat64(o),o+=8)}}return o}var J=(e,r,n,o={})=>{let i=o.buffer??new ArrayBuffer(104857600),s=new DataView(i),a=0,t=[],y=new Map;return(0,f.observe)(e,(0,f.onAdd)(r),p=>{t.push([p,0,-1])}),(0,f.observe)(e,(0,f.onRemove)(r),p=>{t.push([p,1,-1]),y.delete(p)}),n.forEach((p,m)=>{(0,f.isRelation)(p)?((0,f.observe)(e,(0,f.onAdd)(r,p(f.Wildcard)),u=>{let l=(0,f.getRelationTargets)(e,u,p);for(let c of l){y.has(u)||y.set(u,new Map),y.get(u).set(m,c);let b=p(c);t.push([u,4,m,c,b])}}),(0,f.observe)(e,(0,f.onRemove)(r,p(f.Wildcard)),u=>{let l=y.get(u);if(l){let c=l.get(m);c!==void 0&&(t.push([u,5,m,c]),l.delete(m),l.size===0&&y.delete(u))}})):((0,f.observe)(e,(0,f.onAdd)(r,p),u=>{t.push([u,2,m])}),(0,f.observe)(e,(0,f.onRemove)(r,p),u=>{t.push([u,3,m])}))}),()=>{a=0;for(let p=0;p<t.length;p++){let[m,u,l,c,b]=t[p];s.setUint32(a,m),a+=4,s.setUint8(a,u),a+=1,(u===2||u===3||u===4||u===5)&&(s.setUint8(a,l),a+=1,(u===4||u===5)&&(s.setUint32(a,c),a+=4,u===4&&b&&(a=he(b,m,s,a))))}return t.length=0,i.slice(0,a)}},K=(e,r,n,o={})=>{let i=o.idMap||new Map;return(s,a)=>{let t=a||i,y=new DataView(s),p=0;for(;p<s.byteLength;){let m=y.getUint32(p);p+=4;let u=y.getUint8(p);p+=1;let l=-1,c=-1;(u===2||u===3||u===4||u===5)&&(l=y.getUint8(p),p+=1,(u===4||u===5)&&(c=y.getUint32(p),p+=4));let b=n[l],A=t.get(m);if(u===0)A===void 0?(A=(0,f.addEntity)(e),t.set(m,A),(0,f.addComponent)(e,A,r)):console.warn(`Attempted to deserialize addEntity with ID ${m}, but it has already been deserialzied and exists in the mapping.`);else if(A!==void 0&&(0,f.entityExists)(e,A)){if(u===1)(0,f.removeEntity)(e,A),t.delete(m);else if(u===2)(0,f.addComponent)(e,A,b);else if(u===3)(0,f.removeComponent)(e,A,b);else if(u===4){let T=t.get(c);if(T!==void 0){let F=b(T);(0,f.addComponent)(e,A,F),p=Ce(F,A,y,p,t)}}else if(u===5){let T=t.get(c);T!==void 0&&(0,f.removeComponent)(e,A,b(T))}}}return t}};function Ue(e,r){let n=new WeakSet,o,i;return(s,a)=>{n.has(s)||(n.add(s),o=J(s,e[0],e),i=N(e));let t=o(),y=i(a),p=new ArrayBuffer(t.byteLength+y.byteLength),m=new Uint8Array(p);return m.set(new Uint8Array(t),0),m.set(new Uint8Array(y),t.byteLength),p}}function We(e){let r=new WeakSet,n,o;return(i,s,a)=>{r.has(i)||(r.add(i),n=K(i,e[0],e),o=H(e));let t=n(s,a),y=s.slice(t);return o(y,a)}}var X=(o=>(o[o.REPLACE=0]="REPLACE",o[o.APPEND=1]="APPEND",o[o.MAP=2]="MAP",o))(X||{});var Z=Symbol("$modifier");function L(e,r){let n=()=>[e,r];return n[Z]=!0,n}var Re=e=>L(e,"not"),ve=e=>L(e,"or"),De=e=>L(e,"changed");function $e(e){let r=n=>(0,z.query)(n,e);return r.components=e,r}function Oe(e){let r=[],n=new WeakSet;return o=>{n.has(o)||((0,z.observe)(o,(0,z.onAdd)(...e.components),s=>r.push(s)),n.add(o));let i=r.slice();return r.length=0,i}}function Fe(e){let r=[],n=new WeakSet;return o=>{n.has(o)||((0,z.observe)(o,(0,z.onRemove)(...e.components),s=>r.push(s)),n.add(o));let i=r.slice();return r.length=0,i}}var ke=(e,r,n)=>(0,z.addComponent)(e,n,r),we=(e,r,n)=>(0,z.hasComponent)(e,n,r),Be=(e,r,n)=>(0,z.removeComponent)(e,n,r),Ve={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},Y={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Pe=(e,r=1e5)=>{let n=(o,i)=>{let s={};for(let a in o)if(Array.isArray(o[a])){let[t,y]=o[a];s[a]=Array.from({length:y},()=>new Y[t](i))}else if(typeof o[a]=="object")s[a]=n(o[a],i);else{let t=o[a],y=Y[t];if(y)s[a]=new y(i);else throw new Error(`Unsupported type: ${o[a]}`)}return s};return n(e,r)};
//# sourceMappingURL=index.min.cjs.map
