import{observe as ee,onAdd as Re,onRemove as ve,query as De,addComponent as $e,hasComponent as Oe,removeComponent as Fe}from"bitecs";import{addComponent as M,removeComponent as K,addEntity as Se,removeEntity as Ie,observe as F,onAdd as q,onRemove as L,entityExists as ze,isRelation as xe,getRelationTargets as he,Wildcard as X}from"bitecs";var I=Symbol.for("bitecs-u8"),C=Symbol.for("bitecs-i8"),z=Symbol.for("bitecs-u16"),U=Symbol.for("bitecs-i16"),A=Symbol.for("bitecs-u32"),W=Symbol.for("bitecs-i32"),x=Symbol.for("bitecs-f32"),D=Symbol.for("bitecs-f64"),S=Symbol.for("bitecs-ref"),w=Symbol.for("bitecs-str"),V=Symbol.for("bitecs-arr"),h=e=>(r=[])=>Object.defineProperty(r,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ne=(e=[])=>h(I)(e),te=(e=[])=>h(C)(e),oe=(e=[])=>h(z)(e),ie=(e=[])=>h(U)(e),ae=(e=[])=>h(A)(e),ye=(e=[])=>h(W)(e),se=(e=[])=>h(x)(e),ue=(e=[])=>h(D)(e),pe=(e=[])=>h(S)(e),le=(e=[])=>h(w)(e),me=new Map([[ne,I],[te,C],[oe,z],[ie,U],[ae,A],[ye,W],[se,x],[ue,D],[pe,S],[le,w]]),T={[I]:(e,r,n)=>(e.setUint8(r,n),1),[C]:(e,r,n)=>(e.setInt8(r,n),1),[z]:(e,r,n)=>(e.setUint16(r,n),2),[U]:(e,r,n)=>(e.setInt16(r,n),2),[A]:(e,r,n)=>(e.setUint32(r,n),4),[W]:(e,r,n)=>(e.setInt32(r,n),4),[x]:(e,r,n)=>(e.setFloat32(r,n),4),[D]:(e,r,n)=>(e.setFloat64(r,n),8),[S]:(e,r,n)=>(e.setUint32(r,n),4),[w]:(e,r,n)=>{let a=ce.encode(n),s=0;return s+=T[A](e,r+s,a.length),new Uint8Array(e.buffer,e.byteOffset+r+s,a.length).set(a),s+=a.length,s}},g={[I]:(e,r)=>({value:e.getUint8(r),size:1}),[C]:(e,r)=>({value:e.getInt8(r),size:1}),[z]:(e,r)=>({value:e.getUint16(r),size:2}),[U]:(e,r)=>({value:e.getInt16(r),size:2}),[A]:(e,r)=>({value:e.getUint32(r),size:4}),[W]:(e,r)=>({value:e.getInt32(r),size:4}),[x]:(e,r)=>({value:e.getFloat32(r),size:4}),[D]:(e,r)=>({value:e.getFloat64(r),size:8}),[S]:(e,r)=>({value:e.getUint32(r),size:4}),[w]:(e,r)=>{let{value:n,size:o}=g[A](e,r),a=new Uint8Array(e.buffer,e.byteOffset+r+o,n);return{value:be.decode(a),size:o+n}}};function P(e){if(typeof e=="symbol")return e;if(typeof e=="function"){let r=me.get(e);if(r)return r;throw new Error(`Unknown type function: ${e}`)}return R(e)?P(e[V]):x}var ce=new TextEncoder,be=new TextDecoder;function B(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function k(e){if(R(e))return P(e[V]);for(let r of[I,C,z,U,A,W,x,D,w,S])if(r in e)return r;return e instanceof Int8Array?C:e instanceof Uint8Array?I:e instanceof Int16Array?U:e instanceof Uint16Array?z:e instanceof Int32Array?W:e instanceof Uint32Array?A:e instanceof Float32Array?x:D}function R(e){return Array.isArray(e)&&V in e}function O(e){return e[V]}function Q(e,r,n,o){let a=0,s=Array.isArray(r)?1:0;if(a+=T[I](n,o,s),!s)return a;a+=T[A](n,o+a,r.length);for(let i=0;i<r.length;i++){let t=r[i];if(R(e))a+=Q(O(e),t,n,o+a);else{let y=P(e);a+=T[y](n,o+a,t)}}return a}function j(e,r,n,o){let a=0,s=g[I](r,n+a);if(a+=s.size,!s.value)return{size:a};let i=g[A](r,n+a);a+=i.size;let t=new Array(i.value);for(let y=0;y<t.length;y++)if(R(e)){let{value:p,size:m}=j(O(e),r,n+a,o);a+=m,Array.isArray(p)&&(t[y]=p)}else{let p=P(e),{value:m,size:u}=g[p](r,n+a);if(a+=u,p===S){let l=o?o.get(m)??m:m;t[y]=l}else t[y]=m}return{value:t,size:a}}var fe=e=>{let r=k(e);return r===x||r===D},Ae=(e,r)=>fe(e)?r:0,de=(e,r)=>{let n=e.get(r);return n||(ArrayBuffer.isView(r)?n=new r.constructor(r.length):n=new Array(r.length).fill(0),e.set(r,n)),n},N=(e,r,n,o=1e-4)=>{let a=de(e,r),s=r[n],i=Ae(r,o),t=i>0?Math.abs(a[n]-s)>i:a[n]!==s;return a[n]=s,t},Te=(e,r=!1,n,o=1e-4)=>{if(B(e)){let t=k(e),y=T[t];return(p,m,u,l)=>{if(r&&n){if(!N(n,e,u,o))return 0;let c=0;return c+=T[A](p,m+c,u),c+=T[A](p,m+c,l),c+=y(p,m+c,e[u]),c}else{let c=0;return c+=T[A](p,m+c,u),c+=y(p,m+c,e[u]),c}}}let a=Object.keys(e),i=a.map(t=>{let y=e[t];if(!B(y))throw new Error(`Invalid array type for property ${t}`);return k(y)}).map(t=>T[t]||(()=>{throw new Error("Unsupported or unannotated type")}));return(t,y,p,m)=>{if(r&&n){let u=0;for(let b=0;b<a.length;b++){let f=e[a[b]];N(n,f,p,o)&&(u|=1<<b)}if(u===0)return 0;let l=0;l+=T[A](t,y+l,p),l+=T[A](t,y+l,m);let c=a.length<=8?T[I]:a.length<=16?T[z]:T[A];l+=c(t,y+l,u);for(let b=0;b<a.length;b++)if(u&1<<b){let f=e[a[b]];R(f)?l+=Q(O(f),f[p],t,y+l):l+=i[b](t,y+l,f[p])}return l}else{let u=0;u+=T[A](t,y+u,p);for(let l=0;l<a.length;l++){let c=e[a[l]];R(c)?u+=Q(O(c),c[p],t,y+u):u+=i[l](t,y+u,c[p])}return u}}},ge=(e,r=!1)=>{if(B(e)){let s=k(e),i=g[s];return(t,y,p)=>{let m=0,{value:u,size:l}=g[A](t,y);m+=l;let c=p?p.get(u)??u:u;if(r){let{size:d}=g[A](t,y+m);m+=d}let{value:b,size:f}=i(t,y+m);if(s===S){let d=p?p.get(b)??b:b;e[c]=d}else e[c]=b;return m+f}}let n=Object.keys(e),o=n.map(s=>{let i=e[s];if(!B(i))throw new Error(`Invalid array type for property ${s}`);return k(i)}),a=o.map(s=>g[s]||(()=>{throw new Error("Unsupported or unannotated type")}));return(s,i,t)=>{let y=0,{value:p,size:m}=g[A](s,i+y);y+=m;let u=t?t.get(p)??p:p;if(r){let{size:l}=g[A](s,i+y);y+=l;let c=n.length<=8?g[I]:n.length<=16?g[z]:g[A],{value:b,size:f}=c(s,i+y);y+=f;for(let d=0;d<n.length;d++)if(b&1<<d){let $=e[n[d]];if(R($)){let{value:v,size:E}=j(O($),s,i+y,t);Array.isArray(v)&&($[u]=v),y+=E}else{let{value:v,size:E}=a[d](s,i+y);if(o[d]===S){let re=t?t.get(v)??v:v;e[n[d]][u]=re}else e[n[d]][u]=v;y+=E}}}else for(let l=0;l<n.length;l++){let c=e[n[l]];if(R(c)){let{value:b,size:f}=j(O(c),s,i+y,t);Array.isArray(b)&&(c[u]=b),y+=f}else{let{value:b,size:f}=a[l](s,i+y);if(o[l]===S){let d=t?t.get(b)??b:b;e[n[l]][u]=d}else e[n[l]][u]=b;y+=f}}return y}},H=(e,r={})=>{let{diff:n=!1,buffer:o=new ArrayBuffer(1024*1024*100),epsilon:a=1e-4}=r,s=new DataView(o),i=n?new Map:void 0,t=e.map(y=>Te(y,n,i,a));return y=>{let p=0;for(let m=0;m<y.length;m++){let u=y[m];for(let l=0;l<t.length;l++)p+=t[l](s,p,u,l)}return o.slice(0,p)}},J=(e,r={})=>{let{diff:n=!1}=r,o=e.map(a=>ge(a,n));return(a,s)=>{let i=new DataView(a),t=0;for(;t<a.byteLength;)if(n){let{value:y,size:p}=g[A](i,t),{value:m,size:u}=g[A](i,t+p);t+=o[m](i,t,s)}else for(let y=0;y<o.length;y++)t+=o[y](i,t,s)}};function Ce(e,r,n,o){if(!e)return o;if(Array.isArray(e)){let a=e[r];return a!==void 0?S in e?(n.setUint32(o,a),o+4):(n.setFloat64(o,a),o+8):o}if(typeof e=="object"){let a=Object.keys(e).sort();for(let s of a){let i=e[s],t=i[r];t!==void 0&&(i instanceof Int8Array||C in i?(n.setInt8(o,t),o+=1):i instanceof Uint8Array||I in i?(n.setUint8(o,t),o+=1):i instanceof Int16Array||U in i?(n.setInt16(o,t),o+=2):i instanceof Uint16Array||z in i?(n.setUint16(o,t),o+=2):i instanceof Int32Array||W in i?(n.setInt32(o,t),o+=4):i instanceof Uint32Array||A in i||S in i?(n.setUint32(o,t),o+=4):i instanceof Float32Array||x in i?(n.setFloat32(o,t),o+=4):(n.setFloat64(o,t),o+=8))}}return o}function Ue(e,r,n,o,a){if(!e)return o;if(Array.isArray(e)){if(S in e){let s=n.getUint32(o),i=a?a.get(s)??s:s;return e[r]=i,o+4}return e[r]=n.getFloat64(o),o+8}if(typeof e=="object"){let s=Object.keys(e).sort();for(let i of s){let t=e[i];if(t instanceof Int8Array||C in t)t[r]=n.getInt8(o),o+=1;else if(t instanceof Uint8Array||I in t)t[r]=n.getUint8(o),o+=1;else if(t instanceof Int16Array||U in t)t[r]=n.getInt16(o),o+=2;else if(t instanceof Uint16Array||z in t)t[r]=n.getUint16(o),o+=2;else if(t instanceof Int32Array||W in t)t[r]=n.getInt32(o),o+=4;else if(t instanceof Uint32Array||A in t||S in t){let y=n.getUint32(o);if(S in t){let p=a?a.get(y)??y:y;t[r]=p}else t[r]=y;o+=4}else t instanceof Float32Array||x in t?(t[r]=n.getFloat32(o),o+=4):(t[r]=n.getFloat64(o),o+=8)}}return o}var Y=(e,r,n,o={})=>{let a=o.buffer??new ArrayBuffer(104857600),s=new DataView(a),i=0,t=[],y=new Map;return F(e,q(r),p=>{t.push([p,0,-1])}),F(e,L(r),p=>{t.push([p,1,-1]),y.delete(p)}),n.forEach((p,m)=>{xe(p)?(F(e,q(r,p(X)),u=>{let l=he(e,u,p);for(let c of l){y.has(u)||y.set(u,new Map),y.get(u).set(m,c);let b=p(c);t.push([u,4,m,c,b])}}),F(e,L(r,p(X)),u=>{let l=y.get(u);if(l){let c=l.get(m);c!==void 0&&(t.push([u,5,m,c]),l.delete(m),l.size===0&&y.delete(u))}})):(F(e,q(r,p),u=>{t.push([u,2,m])}),F(e,L(r,p),u=>{t.push([u,3,m])}))}),()=>{i=0;for(let p=0;p<t.length;p++){let[m,u,l,c,b]=t[p];s.setUint32(i,m),i+=4,s.setUint8(i,u),i+=1,(u===2||u===3||u===4||u===5)&&(s.setUint8(i,l),i+=1,(u===4||u===5)&&(s.setUint32(i,c),i+=4,u===4&&b&&(i=Ce(b,m,s,i))))}return t.length=0,a.slice(0,i)}},Z=(e,r,n,o={})=>{let a=o.idMap||new Map;return(s,i)=>{let t=i||a,y=new DataView(s),p=0;for(;p<s.byteLength;){let m=y.getUint32(p);p+=4;let u=y.getUint8(p);p+=1;let l=-1,c=-1;(u===2||u===3||u===4||u===5)&&(l=y.getUint8(p),p+=1,(u===4||u===5)&&(c=y.getUint32(p),p+=4));let b=n[l],f=t.get(m);if(u===0)f===void 0?(f=Se(e),t.set(m,f),M(e,f,r)):console.warn(`Attempted to deserialize addEntity with ID ${m}, but it has already been deserialzied and exists in the mapping.`);else if(f!==void 0&&ze(e,f)){if(u===1)Ie(e,f),t.delete(m);else if(u===2)M(e,f,b);else if(u===3)K(e,f,b);else if(u===4){let d=t.get(c);if(d!==void 0){let $=b(d);M(e,f,$),p=Ue($,f,y,p,t)}}else if(u===5){let d=t.get(c);d!==void 0&&K(e,f,b(d))}}}return t}};function Le(e,r){let n=new WeakSet,o,a;return(s,i)=>{n.has(s)||(n.add(s),o=Y(s,e[0],e),a=H(e));let t=o(),y=a(i),p=new ArrayBuffer(t.byteLength+y.byteLength),m=new Uint8Array(p);return m.set(new Uint8Array(t),0),m.set(new Uint8Array(y),t.byteLength),p}}function Ge(e){let r=new WeakSet,n,o;return(a,s,i)=>{r.has(a)||(r.add(a),n=Z(a,e[0],e),o=J(e));let t=n(s,i),y=s.slice(t);return o(y,i)}}var We=(o=>(o[o.REPLACE=0]="REPLACE",o[o.APPEND=1]="APPEND",o[o.MAP=2]="MAP",o))(We||{});var ke=Symbol("$modifier");function G(e,r){let n=()=>[e,r];return n[ke]=!0,n}var Xe=e=>G(e,"not"),Ye=e=>G(e,"or"),Ze=e=>G(e,"changed");function _e(e){let r=n=>De(n,e);return r.components=e,r}function er(e){let r=[],n=new WeakSet;return o=>{n.has(o)||(ee(o,Re(...e.components),s=>r.push(s)),n.add(o));let a=r.slice();return r.length=0,a}}function rr(e){let r=[],n=new WeakSet;return o=>{n.has(o)||(ee(o,ve(...e.components),s=>r.push(s)),n.add(o));let a=r.slice();return r.length=0,a}}var nr=(e,r,n)=>$e(e,n,r),tr=(e,r,n)=>Oe(e,n,r),or=(e,r,n)=>Fe(e,n,r),ir={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},_={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},ar=(e,r=1e5)=>{let n=(o,a)=>{let s={};for(let i in o)if(Array.isArray(o[i])){let[t,y]=o[i];s[i]=Array.from({length:y},()=>new _[t](a))}else if(typeof o[i]=="object")s[i]=n(o[i],a);else{let t=o[i],y=_[t];if(y)s[i]=new y(a);else throw new Error(`Unsupported type: ${o[i]}`)}return s};return n(e,r)};export{ke as $modifier,Ze as Changed,We as DESERIALIZE_MODE,Xe as Not,Ye as Or,ir as Types,nr as addComponent,ar as defineComponent,Ge as defineDeserializer,_e as defineQuery,Le as defineSerializer,er as enterQuery,rr as exitQuery,tr as hasComponent,or as removeComponent};
//# sourceMappingURL=index.min.mjs.map
